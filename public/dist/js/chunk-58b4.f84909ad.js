(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-58b4"],{"0bf3":function(e,s,t){},"0d03":function(e,s,t){"use strict";function n(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function i(e,s){for(var t=0;t<s.length;t++){var n=s[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,s,t){return s&&i(e.prototype,s),t&&i(e,t),e}var a=t("a322"),u=(t("56d7"),t("c0d6")),o=t("90de"),c=function(e){var s=e.data;return Object(o["h"])(s)?JSON.parse(s):s},l=function(){function e(s,t){n(this,e),Object(a["a"])(this,"url",u["a"].state.common.websocketBaseUrl),Object(a["a"])(this,"_heart_beat_time",3e4),Object(a["a"])(this,"_interval_id",null),Object(a["a"])(this,"_ws",null),Object(a["a"])(this,"_event",null),this.event=s,this.ws=new WebSocket(this.url);var i=this;this.ws.onopen=function(e){clearInterval(i._interval_id),i._interval_id=setInterval(function(){i.send(i.event,"beep",1)},i._heart_beat_time),i.send(i.event,"register",t)},this.ws.onmessage=function(e){console.log("socket init",c(e))},this.ws.onclose=function(e){clearInterval(i._interval_id)}}return r(e,[{key:"ws",set:function(e){this._ws=e},get:function(){return this._ws}},{key:"event",set:function(e){this._event=e},get:function(){return this._event}},{key:"isOnline",get:function(){return!!this.ws}}]),r(e,[{key:"send",value:function(e,s,t){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this.isOnline)return!1;if(n){var i=this;return new Promise(function(n,r){i.ws.onmessage=function(e){n(c(e))},i.ws.send(JSON.stringify({event:e,key:s,value:t}))})}this.ws.send(JSON.stringify({event:e,key:s,value:t}))}},{key:"onmessage",value:function(e){this.ws.onmessage=function(s){e(c(s))}}},{key:"close",value:function(){clearInterval(this._interval_id),this.ws.close()}}]),e}(),h=l;s["a"]=h},"0de7":function(e,s,t){"use strict";var n=t("0bf3"),i=t.n(n);i.a},"16e2":function(e,s,t){"use strict";var n=t("1ded"),i=t.n(n);i.a},"1ded":function(e,s,t){},"32a9":function(e,s,t){},7053:function(e,s,t){"use strict";var n=t("8cf6"),i=t.n(n);i.a},"710f":function(e,s,t){"use strict";var n=t("32a9"),i=t.n(n);i.a},"8be4":function(e,s,t){},"8cf6":function(e,s,t){},"9f15":function(e,s,t){"use strict";var n=t("dab9"),i=t.n(n);i.a},a322:function(e,s,t){"use strict";function n(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}t.d(s,"a",function(){return n})},b9a4:function(e,s,t){"use strict";var n=t("8be4"),i=t.n(n);i.a},dab9:function(e,s,t){},f2b7:function(e,s,t){"use strict";t.r(s);var n=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("Chat")},i=[],r=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{attrs:{id:"chat"}},[t("div",{staticClass:"sidebar"},[t("card-component",{attrs:{user:e.user,isOnline:e.isOnline,ws:e.WsObj},on:{getOnline:e.getOnline}}),t("list-component",{attrs:{users:e.chat_users,user_id:e.user_id,isOnline:e.isOnline,ws:e.WsObj,session_user_id:e.session_user_id},on:{setSession:e.setSession}})],1),t("div",{staticClass:"main"},[t("message-component",{ref:"message",attrs:{isOnline:e.isOnline,ws:e.WsObj,user:e.user,session_user:e.session_user}}),t("text-component",{attrs:{isOnline:e.isOnline,ws:e.WsObj,user_id:e.user_id,session_user_id:e.session_user_id}})],1)])},a=[],u=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"chat-card"},[t("header",[e.isOnline?[t("img",{staticClass:"avatar",attrs:{width:"40",height:"40",src:e.thumbnail}}),t("p",{staticClass:"name"},[e._v(e._s(e.user.name))])]:[t("a-alert",{staticStyle:{cursor:"pointer"},attrs:{message:"连接已断开",banner:""},nativeOn:{click:function(s){return e.getOnline(s)}}})]],2),e._m(0)])},o=[function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("footer",[t("input",{staticClass:"search",attrs:{type:"text",placeholder:"search user..."}})])}],c=t("90de"),l={props:{user:{required:!0,type:Object},isOnline:{required:!0,type:Boolean},ws:{required:!0,type:Object}},computed:{thumbnail:{get:function(){return this.user.hasOwnProperty("more")?Object(c["f"])(this.user.more.thumbnail):null}}},data:function(){return{}},methods:{getOnline:function(){this.$emit("getOnline")}}},h=l,_=(t("9f15"),t("2877")),d=Object(_["a"])(h,u,o,!1,null,"b5ab4d0a",null);d.options.__file="Card.vue";var f=d.exports,m=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{directives:[{name:"show",rawName:"v-show",value:e.isOnline,expression:"isOnline"}],staticClass:"chat-list",staticStyle:{height:"500px"}},[t("ul",{staticStyle:{height:"100%",overflow:"auto"}},e._l(e.users,function(s){return s.id!==e.user_id?t("li",{class:{active:e.session_user_id===s.id},on:{click:function(t){e.setSession(s.id)}}},[t("a-badge",{attrs:{count:s.has_new_message?1:0,dot:""}},[t("img",{staticClass:"avatar",class:{gray:!s.online_status},attrs:{width:"30",height:"30",src:e.getImageUrl(s)}}),t("p",{staticClass:"name"},[e._v(e._s(s.name))])])],1):e._e()}))])},v=[],p=(t("c5f6"),{props:{users:{required:!0,type:Array},user_id:{required:!0,type:Number},isOnline:{required:!0,type:Boolean},ws:{required:!0,type:Object},session_user_id:{required:!0,type:Number}},methods:{getImageUrl:function(e){return Object(c["f"])(e.thumbnail_format)},setSession:function(e){this.$emit("setSession",e)},appendBadge:function(){}}}),g=p,b=(t("710f"),Object(_["a"])(g,m,v,!1,null,"163b869a",null));b.options.__file="List.vue";var O=b.exports,w=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"text"},[e.session_user_id?t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.content,expression:"content"}],attrs:{placeholder:"按 Ctrl + Enter 发送"},domProps:{value:e.content},on:{keyup:e.onKeyup,input:function(s){s.target.composing||(e.content=s.target.value)}}}):e._e()])},y=[],j={props:{isOnline:{required:!0,type:Boolean},ws:{required:!0,type:Object},user_id:{required:!0,type:Number},session_user_id:{required:!0,type:Number}},data:function(){return{content:""}},methods:{handleSendMessage:function(e){var s=e.type,t=e.message,n={from_user_id:this.user_id,to_user_id:this.session_user_id,type:s,message:t};this.ws.send("chat","chat_send_message_to_user",n)},onKeyup:function(e){return this.isOnline?!!this.session_user_id&&void(e.ctrlKey&&13===e.keyCode&&this.content.length&&(this.handleSendMessage({type:1,message:this.content}),this.content="")):(this.$message.warning("连接已断开"),!1)}}},k=j,C=(t("0de7"),Object(_["a"])(k,w,y,!1,null,"03218c00",null));C.options.__file="Text.vue";var $=C.exports,x=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"chat-message",attrs:{id:"chat-message"}},[t("ul",e._l(e.messages,function(s){return t("li",{key:s.id},[t("p",{staticClass:"time"},[t("span",[e._v(e._s(e.getDate(s.created_at)))])]),t("div",{staticClass:"main",class:{self:s.from_user_id===e.user.id}},[t("img",{staticClass:"avatar",attrs:{width:"30",height:"30",src:e.getHeadImg(s)}}),t("div",{staticClass:"text"},[e._v(e._s(s.message))])])])}))])},S=[],q={props:{isOnline:{required:!0,type:Boolean},ws:{required:!0,type:Object},user:{required:!0,type:Object},session_user:{required:!0,type:Object}},data:function(){return{messages:[]}},methods:{getDate:function(e){return Object(c["d"])(e)},getHeadImg:function(e){var s=e.from_user_id===this.user.id?this.user.thumbnail_format:this.session_user.thumbnail_format;return Object(c["f"])(s)},setMessage:function(e){this.messages=e,this.scrollDiv()},appendMessage:function(e){this.messages.push(e),this.scrollDiv()},scrollDiv:function(){this.$nextTick(function(){var e=document.getElementById("chat-message");e.scrollTop=e.scrollHeight})}},watch:{session_user:{handler:function(e,s){(e.hasOwnProperty("id")&&s.hasOwnProperty("id")||!e.hasOwnProperty("id")&&s.hasOwnProperty("id"))&&(this.messages=[])},deep:!0}}},I=q,P=(t("b9a4"),Object(_["a"])(I,x,S,!1,null,"1a69f2b0",null));P.options.__file="Message.vue";var W=P.exports,E=t("0d03"),B=t("c24f"),M={components:{CardComponent:f,ListComponent:O,TextComponent:$,MessageComponent:W},data:function(){return{user_id:parseInt(this.$store.state.common.user_id),user:{},online_user_ids:[],chat_users:[],session_user:{},WsObj:{}}},computed:{isOnline:function(){return!!this.WsObj.isOnline},session_user_id:function(){return this.session_user.hasOwnProperty("id")?this.session_user.id:0}},methods:{init:function(){var e=this;this.WsObj=new E["a"]("chat",this.user_id),this.WsObj.onmessage(this.watchSocket),Object(B["h"])().then(function(s){e.user=s.data}),Object(B["f"])({current_page:0,filter:{}}).then(function(s){for(var t=s.data.rows,n=0;n<t.length;n++)t[n].online_status=0;if(e.online_user_ids.length)for(var i=0;i<t.length;i++){var r=t[i].id;Object(c["g"])(r,e.online_user_ids)&&(t[i].online_status=1)}e.chat_users=t})},watchSocket:function(e){if(!e.success)return!1;if(!e.hasOwnProperty("data")||!e.data)return console.log("res data null"),!1;if("chat"!==e.event||!e.data.hasOwnProperty("key"))return!1;var s=e.data,t=s.key;switch(t){case"chat_chat_users_status":if(this.online_user_ids=s.uids,this.chat_users.length)for(var n=0;n<this.chat_users.length;n++){var i=this.chat_users[n].id;Object(c["g"])(i,this.online_user_ids)?this.$set(this.chat_users[n],"online_status",1):this.$set(this.chat_users[n],"online_status",0)}break;case"chat_new_message":s.from_user_id===this.session_user_id?this.$refs.message.appendMessage(s):this.appendListBadge(s.from_user_id);break;case"chat_send_feedback":this.$refs.message.appendMessage(s);break;case"chat_user_get_online":var r=s.user_id;this.handleUserGetOnline(r);break;case"chat_user_get_offline":r=s.user_id,this.handleUserGetOffline(r);break;case"chat_set_session_uid":var a=s.rows;this.$refs.message.setMessage(a);break}},appendListBadge:function(e){for(var s=0;s<this.chat_users.length;s++)if(this.chat_users[s].id===e)return this.$set(this.chat_users[s],"has_new_message",1),!0},handleUserGetOnline:function(e){for(var s=0;s<this.chat_users.length;s++)if(this.chat_users[s].id===e)return this.$set(this.chat_users[s],"online_status",1),this.chat_users.unshift(this.chat_users.splice(s,1)[0]),!0},handleUserGetOffline:function(e){for(var s=0;s<this.chat_users.length;s++)if(this.chat_users[s].id===e)return this.$set(this.chat_users[s],"online_status",0),!0},getOnline:function(){var e=this;this.$confirm({title:"操作确认",content:"要重新连接推送服务器吗？",onOk:function(){e.init()},onCancel:function(){console.log("Cancel")},class:"test"})},setSession:function(e){var s=this;this.session_user={};var t={from_user_id:this.user_id,session_user_id:e};this.WsObj.send("chat","chat_set_session_uid",t),Object(B["h"])(e).then(function(t){s.session_user=t.data;for(var n=0;n<s.chat_users.length;n++)if(s.chat_users[n].id===e)return s.$set(s.chat_users[n],"has_new_message",0),!0})}},mounted:function(){},beforeDestroy:function(){this.isOnline&&this.WsObj.close()}},N=M,U=(t("7053"),Object(_["a"])(N,r,a,!1,null,"4ed052ce",null));U.options.__file="Index.vue";var D=U.exports,J=D,T={name:"Index",components:{Chat:J}},G=T,L=(t("16e2"),Object(_["a"])(G,n,i,!1,null,"6c1c23b9",null));L.options.__file="Index.vue";s["default"]=L.exports}}]);
//# sourceMappingURL=chunk-58b4.f84909ad.js.map